rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    // Check if user is authenticated
    function isAuthed() {
      return request.auth != null;
    }

    // Check if user belongs to a specific business
    function hasBiz(bid) {
      return isAuthed() && 
             request.auth.token.businessIds != null &&
             bid in request.auth.token.businessIds;
    }

    // Check if user has admin role
    function isAdmin() {
      return isAuthed() && 
             request.auth.token.roles != null &&
             'admin' in request.auth.token.roles;
    }

    // Check if user has driver role
    function isDriver() {
      return isAuthed() && 
             request.auth.token.roles != null &&
             'driver' in request.auth.token.roles;
    }

    // Check if user is admin for specific business
    function isBusinessAdmin(bid) {
      return hasBiz(bid) && isAdmin();
    }

    // ========================================
    // GLOBAL USERS COLLECTION (for push notifications & mobile app)
    // ========================================
    match /users/{uid} {
      // CRITICAL: Allow any authenticated user to read user documents
      // Mobile app and admin dashboard both need this access
      allow read: if isAuthed();
      
      // CRITICAL: Allow users to create their own document (first-time registration with push token)
      allow create: if isAuthed() && 
                      (request.auth.uid == uid || 
                       (request.resource.data.phone != null && 
                        request.resource.data.phone is string));
      
      // Allow users to update their own document (push token updates)
      allow update: if isAuthed() && (request.auth.uid == uid || isAdmin());
      
      // Only allow users to delete their own document
      allow delete: if isAuthed() && request.auth.uid == uid;
    }

    // ========================================
    // TENANT-SCOPED COLLECTIONS
    // ========================================
    match /menus/{businessId} {
      
      // Business settings document (read by anyone with access, write by admins only)
      allow read: if hasBiz(businessId) || true; // Public read for menu display
      allow write: if isBusinessAdmin(businessId);

      // ========================================
      // USERS SUBCOLLECTION (per-business membership)
      // ========================================
      match /users/{uid} {
        // Users can read all members of their business
        allow read: if hasBiz(businessId);
        // Only admins can create/update user memberships
        allow create, update: if isBusinessAdmin(businessId);
        // Prevent deletion (soft delete via status field instead)
        allow delete: if false;
      }

      // ========================================
      // ORDERS SUBCOLLECTION
      // ========================================
      match /orders/{orderId} {
        // Read access:
        // - Admins: can read all orders
        // - Drivers: can read orders (filtering happens client-side for assignedDriverId)
        // Note: Query-level filtering by assignedDriverId is handled in the app,
        // but drivers can read orders to see unassigned ones and their assigned ones
        allow read: if hasBiz(businessId) && (isAdmin() || isDriver());
        
        // Update access:
        // - Admins: can update all orders
        // - Drivers: can update orders assigned to them OR unassigned orders (to accept them)
        // This prevents drivers from updating other drivers' assigned orders
        allow update: if hasBiz(businessId) && (
          isAdmin() || 
          (isDriver() && (
            resource.data.assignedDriverId == request.auth.uid ||
            (!resource.data.assignedDriverId || resource.data.assignedDriverId == null)
          ))
        );
        
        // Only admins can create orders from dashboard (customers create via functions)
        allow create: if isBusinessAdmin(businessId);
        
        // Only admins can delete orders
        allow delete: if isBusinessAdmin(businessId);
      }

      // ========================================
      // PRODUCTS/MEALS SUBCOLLECTION
      // ========================================
      match /products/{productId} {
        // Public read for menu display (or restrict to hasBiz if needed)
        allow read: if true;
        // Only admins can manage products
        allow write: if isBusinessAdmin(businessId);
      }

      // ========================================
      // CATEGORIES SUBCOLLECTION
      // ========================================
      match /categories/{categoryId} {
        // Public read for menu display
        allow read: if true;
        // Only admins can manage categories
        allow write: if isBusinessAdmin(businessId);
      }

      // ========================================
      // COUPONS SUBCOLLECTION
      // ========================================
      match /coupons/{couponId} {
        // Business members can read coupons (for validation)
        allow read: if hasBiz(businessId) || true; // Public read for customer validation
        // Only admins can manage coupons
        allow write: if isBusinessAdmin(businessId);
      }

      // ========================================
      // MEDIA SUBCOLLECTION
      // ========================================
      match /media/{mediaId} {
        // Public read for displaying images
        allow read: if true;
        // Only admins can manage media
        allow write: if isBusinessAdmin(businessId);
      }

      // ========================================
      // DRIVERS SUBCOLLECTION (if separate from users)
      // ========================================
      match /drivers/{driverId} {
        // Business members can read drivers
        allow read: if hasBiz(businessId);
        // Only admins can manage drivers
        allow write: if isBusinessAdmin(businessId);
      }

      // ========================================
      // ANALYTICS/STATS SUBCOLLECTION
      // ========================================
      match /analytics/{docId} {
        // Only business members can read analytics
        allow read: if hasBiz(businessId);
        // Only admins can write analytics
        allow write: if isBusinessAdmin(businessId);
      }

      // ========================================
      // NOTIFICATIONS SUBCOLLECTION
      // ========================================
      match /notifications/{notificationId} {
        // Business members can read notifications
        allow read: if hasBiz(businessId);
        // System/admins can write notifications
        allow write: if isBusinessAdmin(businessId);
      }
    }

    // ========================================
    // DENY ALL OTHER PATHS
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}









