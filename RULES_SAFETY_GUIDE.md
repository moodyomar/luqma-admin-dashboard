# ğŸ›¡ï¸ ××“×¨×™×š ×‘×˜×™×—×•×ª ×œ×¢×‘×•×“×” ×¢× Firestore Rules

## âš ï¸ ×”×‘×¢×™×”: "×›×œ ×¤×¢× ×©××ª×§× ×™× ××©×”×•, ××©×”×• ××—×¨ ××ª×§×œ×§×œ"

×–×” ×§×•×¨×” ×›×™ Firestore Rules ××©×¤×™×¢×•×ª ×–×• ×¢×œ ×–×•. ×©×™× ×•×™ ×§×˜×Ÿ ×™×›×•×œ ×œ×©×‘×•×¨ ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ××—×¨×ª.

---

## âœ… ×¤×ª×¨×•×Ÿ: ×ª×”×œ×™×š ×¢×‘×•×“×” ×‘×˜×•×—

### **×©×œ×‘ 1: ×œ×¤× ×™ ×›×œ ×©×™× ×•×™**

1. **×ª×¢×“ ××ª ×”××¦×‘ ×”× ×•×›×—×™:**
   ```bash
   # ×©××•×¨ ×’×™×‘×•×™ ×©×œ ×”-rules ×”× ×•×›×—×™×•×ª
   cp firestore.rules firestore.rules.backup.$(date +%Y%m%d_%H%M%S)
   ```

2. **×¨×©×•× ××” ××ª×” ×¨×•×¦×” ×œ×ª×§×Ÿ:**
   - ××” ×”×‘×¢×™×”?
   - ××” ××ª×” ×¨×•×¦×” ×œ××¤×©×¨?
   - ××” ××ª×” ×¨×•×¦×” ×œ×× ×•×¢?

3. **×‘×“×•×§ ××ª ×›×œ ×”×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×”×§×©×•×¨×”:**
   - ××™×œ×• Cloud Functions ××©×ª××©×•×ª ×‘×–×”?
   - ××™×œ×• ××¡×›×™× ×‘××¤×œ×™×§×¦×™×” ××©×ª××©×™× ×‘×–×”?
   - ××™×œ×• ××¡×›×™× ×‘-admin dashboard ××©×ª××©×™× ×‘×–×”?

---

### **×©×œ×‘ 2: ×‘×“×™×§×” ×œ×¤× ×™ ×©×™× ×•×™**

#### **×¨×©×™××ª ×‘×“×™×§×” (Checklist):**

- [ ] **Users Collection:**
  - [ ] ×”×× ××©×ª××©×™× ×™×›×•×œ×™× ×œ×™×¦×•×¨ ××¡××š ×—×“×©? (push tokens)
  - [ ] ×”×× ××©×ª××©×™× ×™×›×•×œ×™× ×œ×¢×“×›×Ÿ ××ª ×”××¡××š ×©×œ×”×?
  - [ ] ×”×× admins ×™×›×•×œ×™× ×œ×§×¨×•×/×œ×¢×“×›×Ÿ ×›×œ ××©×ª××©?

- [ ] **Orders Collection:**
  - [ ] ×”×× ×œ×§×•×—×•×ª ×™×›×•×œ×™× ×œ×™×¦×•×¨ ×”×–×× ×•×ª?
  - [ ] ×”×× ×œ×§×•×—×•×ª ×™×›×•×œ×™× ×œ××—×•×§ ×”×–×× ×•×ª pending ×©×œ×”×?
  - [ ] ×”×× drivers ×™×›×•×œ×™× ×œ×¢×“×›×Ÿ ×”×–×× ×•×ª ×©×”×•×§×¦×• ×œ×”×?
  - [ ] ×”×× admins ×™×›×•×œ×™× ×œ×¢×“×›×Ÿ ×›×œ ×”×–×× ×”?

- [ ] **Coupons Collection:**
  - [ ] ×”×× ×œ×§×•×—×•×ª ×™×›×•×œ×™× ×œ×§×¨×•× ×§×•×¤×•× ×™×? (validation)
  - [ ] ×”×× admins ×™×›×•×œ×™× ×œ×™×¦×•×¨/×œ×¢×“×›×Ÿ ×§×•×¤×•× ×™×?
  - [ ] ×”×× global admins ×™×›×•×œ×™× ×œ× ×”×œ ×§×•×¤×•× ×™×?

- [ ] **Referral System:**
  - [ ] ×”×× ××©×ª××©×™× ×™×›×•×œ×™× ×œ×§×¨×•× ××ª ×”×”×™×¡×˜×•×¨×™×” ×©×œ×”×?
  - [ ] ×”×× Cloud Functions ×™×›×•×œ×™× ×œ×™×¦×•×¨/×œ×¢×“×›×Ÿ referral transactions?
  - [ ] ×”×× admins ×™×›×•×œ×™× ×œ××—×•×§ referral data? (debug tools)

- [ ] **Menu/Products:**
  - [ ] ×”×× ×”××¤×œ×™×§×¦×™×” ×™×›×•×œ×” ×œ×§×¨×•× ×ª×¤×¨×™×˜ ×œ×¤× ×™ ×”×ª×—×‘×¨×•×ª?
  - [ ] ×”×× admins ×™×›×•×œ×™× ×œ× ×”×œ ××•×¦×¨×™×?

---

### **×©×œ×‘ 3: ×©×™× ×•×™ ×–×”×™×¨**

#### **×¢×§×¨×•× ×•×ª:**

1. **×ª××™×“ ×”×©×ª××© ×‘-`||` (OR) ×‘××§×•× ×œ×”×—×œ×™×£ ×œ×’××¨×™:**
   ```javascript
   // âŒ ×¨×¢ - ××—×œ×™×£ ××ª ×›×œ ×”×›×œ×œ ×”×§×•×“×
   allow write: if isAdmin();
   
   // âœ… ×˜×•×‘ - ××•×¡×™×£ ××¤×©×¨×•×ª × ×•×¡×¤×ª
   allow write: if isBusinessAdmin(businessId) || isAdmin();
   ```

2. **×ª××™×“ ×©××•×¨ ×¢×œ backward compatibility:**
   ```javascript
   // âœ… ×˜×•×‘ - ×©×•××¨ ×¢×œ ×”×›×œ×œ ×”×§×•×“× + ××•×¡×™×£ ×—×“×©
   allow delete: if isBusinessAdmin(businessId) || 
                 (isAuthed() && 
                  resource.data.status == 'pending' &&
                  resource.data.userId == request.auth.uid);
   ```

3. **××œ ×ª×©× ×” rules ×§×¨×™×˜×™×•×ª:**
   ```javascript
   // âš ï¸ ××œ ×ª×©× ×” ××ª ×–×” - ×–×” ×©×•×‘×¨ push notifications!
   match /users/{uid} {
     allow create: if isAuthed() && 
                     (request.auth.uid == uid || 
                      (request.resource.data.phone != null && 
                       request.resource.data.phone is string));
   }
   ```

4. **××œ ×ª×©× ×” rules ×©×œ menu read:**
   ```javascript
   // âš ï¸ ××œ ×ª×©× ×” ××ª ×–×” - ×–×” ×©×•×‘×¨ ×˜×¢×™× ×ª ×ª×¤×¨×™×˜!
   match /menus/{businessId} {
     allow read: if hasBiz(businessId) || true; // Public read
   }
   ```

---

### **×©×œ×‘ 4: ×‘×“×™×§×” ××—×¨×™ ×©×™× ×•×™**

#### **×‘×“×™×§×•×ª ×—×•×‘×”:**

1. **×‘×“×•×§ ××ª ×”-syntax:**
   ```bash
   firebase firestore:rules:validate
   ```

2. **Deploy ×œ×‘×“×™×§×”:**
   ```bash
   firebase deploy --only firestore:rules
   ```

3. **×‘×“×•×§ ×¤×•× ×§×¦×™×•× ×œ×™×•×ª:**
   - [ ] ×”×× push notifications ×¢×•×‘×“×™×? (×”×ª×—×‘×¨×•×ª ××©×ª××© ×—×“×©)
   - [ ] ×”×× ×ª×¤×¨×™×˜ × ×˜×¢×Ÿ ×œ×¤× ×™ ×”×ª×—×‘×¨×•×ª?
   - [ ] ×”×× ×”×–×× ×•×ª × ×•×¦×¨×•×ª?
   - [ ] ×”×× admins ×™×›×•×œ×™× ×œ× ×”×œ ×”×›×œ?
   - [ ] ×”×× debug tools ×¢×•×‘×“×™×?

4. **×‘×“×•×§ console logs:**
   - ×—×¤×© ×©×’×™××•×ª "permission-denied"
   - ×‘×“×•×§ ×× ×™×© warnings

---

### **×©×œ×‘ 5: Rollback ×× ××©×”×• ×œ× ×¢×•×‘×“**

```bash
# ×©×—×–×¨ ××ª ×”×’×™×‘×•×™
cp firestore.rules.backup.YYYYMMDD_HHMMSS firestore.rules

# Deploy ××—×“×©
firebase deploy --only firestore:rules
```

---

## ğŸš¨ Rules ×§×¨×™×˜×™×•×ª - ××œ ×ª×©× ×” ××•×ª×Ÿ!

### **1. Users Collection - Push Tokens:**
```javascript
match /users/{uid} {
  // âš ï¸ ××œ ×ª×©× ×” ××ª ×–×”!
  allow create: if isAuthed() && 
                  (request.auth.uid == uid || 
                   (request.resource.data.phone != null && 
                    request.resource.data.phone is string));
  
  // âš ï¸ ××œ ×ª×©× ×” ××ª ×–×”!
  allow read: if isAuthed();
}
```

**×œ××”:** ×–×” ×©×•×‘×¨ push notifications ×× ××©×ª××©×™× ×—×“×©×™× ×œ× ×™×›×•×œ×™× ×œ×™×¦×•×¨ ××¡××š.

---

### **2. Menu Read - Public Access:**
```javascript
match /menus/{businessId} {
  // âš ï¸ ××œ ×ª×©× ×” ××ª ×–×”!
  allow read: if hasBiz(businessId) || true; // Public read
}
```

**×œ××”:** ×”××¤×œ×™×§×¦×™×” ×¦×¨×™×›×” ×œ×˜×¢×•×Ÿ ×ª×¤×¨×™×˜ ×œ×¤× ×™ ×”×ª×—×‘×¨×•×ª.

---

### **3. Orders Create - Any Authenticated User:**
```javascript
match /orders/{orderId} {
  // âš ï¸ ××œ ×ª×©× ×” ××ª ×–×”!
  allow create: if isAuthed();
}
```

**×œ××”:** ×œ×§×•×—×•×ª ×¦×¨×™×›×™× ×œ×™×¦×•×¨ ×”×–×× ×•×ª.

---

## ğŸ“‹ Template ×œ×©×™× ×•×™ ×‘×˜×•×—

```javascript
// ========================================
// BEFORE: ××” ×”×™×” ×§×•×“×
// ========================================
allow write: if isBusinessAdmin(businessId);

// ========================================
// AFTER: ××” ×©×™× ×™× ×• + ×œ××”
// ========================================
// ×©×™× ×•×™: ×”×•×¡×¤× ×• ××¤×©×¨×•×ª ×œ-global admins ×œ× ×”×œ ×§×•×¤×•× ×™×
// ×¡×™×‘×”: global admins ×œ× ×™×›×œ×• ×œ×¢×¨×•×š ×§×•×¤×•× ×™×
// ×‘×“×™×§×”: [ ] admins ×™×›×•×œ×™× ×œ×¢×¨×•×š ×§×•×¤×•× ×™×
//         [ ] business admins ×¢×“×™×™×Ÿ ×™×›×•×œ×™×
allow write: if isBusinessAdmin(businessId) || isAdmin();
```

---

## ğŸ” Debugging Checklist

×× ××©×”×• ×œ× ×¢×•×‘×“ ××—×¨×™ ×©×™× ×•×™:

1. **×‘×“×•×§ ××ª ×”-error message:**
   - "permission-denied" = rules problem
   - "not-found" = document doesn't exist
   - "invalid-argument" = data problem

2. **×‘×“×•×§ ××ª ×”-context:**
   - ××™ ×”××©×ª××©? (admin? customer? driver?)
   - ××” ×”×•× ×× ×¡×” ×œ×¢×©×•×ª? (create? read? update? delete?)
   - ××™×–×” collection? (users? orders? coupons?)

3. **×‘×“×•×§ ××ª ×”-rules:**
   - ×”×× ×™×© `allow` ×¢×‘×•×¨ ×”×¤×¢×•×œ×” ×”×–×•?
   - ×”×× ×”×ª× ××™× × ×›×•× ×™×?
   - ×”×× ×™×© `||` ×‘××§×•× `&&`?

4. **×‘×“×•×§ custom claims:**
   - ×”×× ×”××©×ª××© authenticated?
   - ×”×× ×™×© ×œ×• ××ª ×”-roles ×”× ×›×•× ×™×?
   - ×”×× ×™×© ×œ×• ××ª ×”-businessIds ×”× ×›×•× ×™×?

---

## âœ… ×¡×™×›×•×: ×ª×”×œ×™×š ×¢×‘×•×“×” ×‘×˜×•×—

1. **×ª×¢×“** - ×©××•×¨ ×’×™×‘×•×™
2. **×‘×“×•×§** - ×¨×©×™××ª ×‘×“×™×§×” ×œ×¤× ×™ ×©×™× ×•×™
3. **×©× ×”** - ×–×”×™×¨, ×¢× `||` ×‘××§×•× ×œ×”×—×œ×™×£
4. **×‘×“×•×§** - ××—×¨×™ ×©×™× ×•×™, ×‘×“×•×§ ×”×›×œ
5. **Rollback** - ×× ××©×”×• ×œ× ×¢×•×‘×“, ×©×—×–×¨

---

## ğŸ¯ ×›×œ×œ×™ ×–×”×‘

1. **×ª××™×“ ×©××•×¨ ×’×™×‘×•×™ ×œ×¤× ×™ ×©×™× ×•×™**
2. **×ª××™×“ ×”×©×ª××© ×‘-`||` (OR) ×‘××§×•× ×œ×”×—×œ×™×£**
3. **×ª××™×“ ×‘×“×•×§ ××ª ×›×œ ×”×¤×•× ×§×¦×™×•× ×œ×™×•×ª ××—×¨×™ ×©×™× ×•×™**
4. **××œ ×ª×©× ×” rules ×§×¨×™×˜×™×•×ª (users, menu read)**
5. **×ª××™×“ ×ª×ª×¢×“ ×œ××” ×©×™× ×™×ª**

---

## ğŸ“ ×× ××©×”×• ×œ× ×¢×•×‘×“

1. ×©×—×–×¨ ××ª ×”×’×™×‘×•×™
2. ×‘×“×•×§ ××ª ×”-console logs
3. ×‘×“×•×§ ××ª ×”-rules syntax
4. ×‘×“×•×§ ××ª ×”-custom claims
5. ×ª×©××œ ××•×ª×™ ×œ×¤× ×™ ×©×™× ×•×™ × ×•×¡×£! ğŸ˜Š

